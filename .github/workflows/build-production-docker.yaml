---

name: Build Production Docker Image
on:
  push:
    tags:
      - v*

jobs:
    build-docker:
        name: Build Production Docker Image
        runs-on: ubuntu-18.04
        env:
            DOCKER_PREFIX: docker.pkg.github.com/svthalia/concrexit/production
            DOCKER_LATEST: docker.pkg.github.com/svthalia/concrexit/production:latest
            DOCKER_DEPENDENCIES_LATEST: docker.pkg.github.com/svthalia/concrexit/dependencies:latest
        steps:
            - name: Get version
              run: echo ::set-env name=DOCKER_VERSION::${GITHUB_REF/refs\/tags\//}

            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Login to GitHub Packages
              run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login https://docker.pkg.github.com --username "{{ github.repository }}" --password-stdin

            - name: Build Docker images
              run: |
                  docker build --file Dockerfile.dependencies --quiet --build-arg "install_dev_requirements=0" --tag "${DOCKER_DEPENDENCIES_LATEST}" .
                  docker build --quiet --build-arg "source_commit=${{ github.sha }}" --tag "${DOCKER_LATEST}" .

            - name: Push Docker image
              run: |
                  docker tag "${DOCKER_LATEST}" "${DOCKER_PREFIX}:${DOCKER_VERSION}"
                  docker push "${DOCKER_PREFIX}:${DOCKER_VERSION}"
                  docker push "${DOCKER_LATEST}"
